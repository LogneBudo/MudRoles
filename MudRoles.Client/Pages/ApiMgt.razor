@page "/apikeys"
@using MudRoles.Client.Models
@using System.Net.Http.Json
@inject HttpClient HttpClient
@inject IDialogService DialogService
@inject IConfiguration Configuration
@attribute [Authorize]
<PageTitle>Api Management</PageTitle>

<MudGrid>
    <MudItem xs="12">
        <MudText Typo="Typo.h3" GutterBottom="true">API Keys Management</MudText>
        <MudText Typo="Typo.body1" GutterBottom="true">These API Keys should only be used when developing and testing your application</MudText>
    </MudItem>
    <MudItem xs="12" Class="d-flex justify-end">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" DropShadow="true" ButtonType="ButtonType.Submit" @onclick="@(() => PostGenerateAsync(scopes))">Generate API Keys</MudButton>
    </MudItem>
</MudGrid>

@{
    // TODO this works (C# comment)
    /* TODO this works 
     * Voila this is working
     * (C# multi-line comment) */
}
<MudTabs Elevation="2" Outlined="true" Position="Position.Top" Rounded="true" Border="true"
         ApplyEffectsToContainer="true" Class="mt-8" PanelClass="pa-6">
    <MudTabPanel Text="Vault">
        <MudText Typo="Typo.h5" GutterBottom="true">Active</MudText>
        <MudDataGrid T="ApiKey" Hover="true" Items="@userApiKeys">
            <Columns>
                <PropertyColumn HeaderClass="font-bold" Property="x => x.Name" CellStyleFunc="@_cellStyleFunc" />
                <TemplateColumn Title="Key">
                    <CellTemplate Context="cellContext">
                        @if (cellContext.Item.Key != null)
                        {
                            <MudFab Size="Size.Small" EndIcon="@Icons.Material.Filled.VisibilityOff" Label="@($"{cellContext.Item.KeyPrefix}...{cellContext.Item.Key.Substring(cellContext.Item.Key.Length - 5)}")" OnClick="@(() => ToggleKeyVisibility(cellContext.Item))" />
                        }
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Scopes">
                    <CellTemplate Context="cellContext">
                        @foreach (var scope in cellContext.Item.Scopes)
                        {
                            <MudChip Color="Color.Primary" Icon="@Icons.Material.Filled.Api" Variant="Variant.Outlined" Class="m-1">
                                @($"{scope.Controller}")
                            </MudChip>
                            <MudChip Size="Size.Small" Color="Color.Dark">  @($"{scope.Verb}") </MudChip>
                            <MudChip  Size="Size.Small" Color="Color.Primary">  @($"{scope.Endpoint}") </MudChip><br />
                        }
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Created">
                    <CellTemplate Context="cellContext">
                        @cellContext.Item.CreationDate.ToFormattedString("yyyy-MM-dd HH:mm")                      
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Expires">
                    <CellTemplate Context="cellContext">
                        @cellContext.Item.ExpirationDate.ToTimeSpanString(cellContext.Item.CreationDate)
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn CellClass="justify-end">
                    <CellTemplate Context="cellContext">
                        <MudStack Row>
                            <MudButton Variant="@Variant.Filled" Color="@Color.Primary" OnClick="@(()=> DeleteKey(cellContext.Item.Id))">Delete</MudButton>
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <NoRecordsContent>
                <MudText>No keys available</MudText>
            </NoRecordsContent>
        </MudDataGrid>
        <br />
        <br />
        <br />
        <MudText Typo="Typo.h5" GutterBottom="true">Recently Expired</MudText>
        <MudDataGrid T="ApiKey" Hover="true" Items="@userApiKeys.Where(x => x.ExpirationDate < DateTime.Now).ToList()">
            <Columns>
                <PropertyColumn Property="x => x.Name" CellStyleFunc="@_cellStyleFunc" />
                <PropertyColumn Property="x => x.Key" />
                <PropertyColumn Property="x => x.CreationDate" Title="Created" />
                <PropertyColumn Property="x => x.ExpirationDate.ToShortDateString()" Title="Expires" />
                <PropertyColumn Property="x => x.Scopes" />
                <TemplateColumn CellClass="d-flex justify-end">
                    <CellTemplate>
                        <MudStack Row>
                            <MudButton Size="@Size.Small" Variant="@Variant.Filled" Color="@Color.Primary">Renew</MudButton>
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <NoRecordsContent>
                <MudText>No Expired keys available</MudText>
            </NoRecordsContent>
        </MudDataGrid>
    </MudTabPanel>
    <MudTabPanel Text="Expiered Keys">
        <MudText>Content Store</MudText>
    </MudTabPanel>
    <MudTabPanel Text="Users">
        <MudText>Content Users</MudText>
    </MudTabPanel>
</MudTabs>
<br />
<style>
    .mud-table-head {
        font-weight: 500;
    }
        /* Change this to your desired font weight */
</style>
@code {
    private string apiKey = "";
    private List<ApiKey> userApiKeys = new();
    private string errorMessage = string.Empty;
    private List<Scope> scopes = new();
    private async Task DoShit()
    {
        await Task.Yield();
    }
    protected override async Task OnInitializedAsync()
    {
        try
        {
            var response = await HttpClient.GetAsync("api/configuration/apikey");
            response.EnsureSuccessStatusCode();
            apiKey = await response.Content.ReadAsStringAsync();
            Console.WriteLine($"Fetched API Key: {apiKey}");
            await LoadScopes();
            await LoadApiKeys();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error fetching API key: {ex.Message}";
        }
    }
    private Func<ApiKey, string> _cellStyleFunc => x =>
    {
        string style = "font-weight:bold";

        return style;
    };
    private async Task PostGenerateAsync(List<Scope> scopes)
    {
        // Add the API key to the request headers
        HttpClient.DefaultRequestHeaders.Clear();
        HttpClient.DefaultRequestHeaders.Add("ApiKey", apiKey);

        var parameters = new DialogParameters<ApiKeyDialog> { { x => x.Scopes, scopes } };
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialog = await DialogService.ShowAsync<ApiKeyDialog>("API Key Generator", parameters, options);
        var result = await dialog.Result;
        KeyInputModel keyResult = new();
        if (result != null && !result.Canceled)
        {
            keyResult = result.Data as KeyInputModel ?? new KeyInputModel();
            var name = keyResult.ApiKeyName;
            var scopejson = keyResult.Scopes;
        }

        var response = await HttpClient.PostAsJsonAsync<KeyInputModel>("api/apikeys", keyResult);
        if (response.IsSuccessStatusCode)
        {
            await LoadApiKeys(); // Reload the keys after generating a new one
        }
        else
        {
            errorMessage = "Failed to generate API key.";
        }
    }
    public sealed class Scope
    {
        public string? Controller { get; set; }
        public string? Verb { get; set; }
        public string? Endpoint { get; set; }
        public bool IsChecked { get; set; }
    }
    private async Task DeleteKey(int apiKeyId)
    {
        try
        {
            var response = await HttpClient.DeleteAsync($"api/apikeys/{apiKeyId}");
            response.EnsureSuccessStatusCode();
        }
        catch (HttpRequestException ex)
        {
            var errorMessage = "Failed to delete API key.";
            // Log the exception or handle it as needed
            Console.WriteLine($"{errorMessage} Exception: {ex.Message}");
        }
        catch (Exception ex)
        {
            var errorMessage = "An unexpected error occurred.";
            // Log the exception or handle it as needed
            Console.WriteLine($"{errorMessage} Exception: {ex.Message}");
        }
    }

    private async Task LoadScopes()
    {
        try
        {
            HttpClient.DefaultRequestHeaders.Clear();
            HttpClient.DefaultRequestHeaders.Add("ApiKey", apiKey);
            var response = await HttpClient.GetFromJsonAsync<List<Scope>>("api/apikeys/scopes");
            scopes = response ?? new List<Scope>(); // Handle null response
            errorMessage = string.Empty; // Clear any previous error messages
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading scopes: {ex.Message}";
        }
    }
    private async Task LoadApiKeys()
    {
        try
        {
            HttpClient.DefaultRequestHeaders.Clear();
            HttpClient.DefaultRequestHeaders.Add("ApiKey", apiKey);
            var response = await HttpClient.GetFromJsonAsync<List<ApiKey>>("api/apikeys");
            userApiKeys = response ?? new List<ApiKey>(); // Handle null response
            errorMessage = string.Empty; // Clear any previous error messages
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading API keys: {ex.Message}";
        }
        StateHasChanged();
    }
    private void ToggleKeyVisibility(ApiKey apiKey)
    {
        apiKey.IsKeyVisible = !apiKey.IsKeyVisible;
    }
    internal class ApiKey
    {
        public int Id { get; set; }

        public string? Name { get; set; }

        public string? KeyPrefix { get; set; }
        public string? Key { get; set; }
        public DateTime CreationDate { get; set; }
        public DateTime ExpirationDate { get; set; }
        public string? UserId { get; set; }
        public List<Scope> Scopes { get; set; } = new();
        public bool IsKeyVisible { get; set; } = false; // New property to track visibility
    }
}
